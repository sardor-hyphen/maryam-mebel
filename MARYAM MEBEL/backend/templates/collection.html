<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kolleksiya - Maryam Furniture</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,700;0,800;1,600&display=swap" rel="stylesheet">

    <!-- GSAP for advanced animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --color-red: #D50000;
            --color-white: #F5F5F5;
            --color-black: #050505;
            --color-dark-gray: #121212;
            --color-mid-gray: #212121;
            --color-light-gray: #424242;
            --font-heading: 'Playfair Display', serif;
            --font-body: 'Inter', sans-serif;
            --spacing-sm: 1rem;
            --spacing-md: 2rem;
            --spacing-lg: 3rem;
            --container-max-width: 1600px;
            --border-radius: 16px;
            --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.5);
            --transition-smooth: 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }

        body {
            font-family: var(--font-body);
            background-color: var(--color-black);
            color: var(--color-white);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated Background */
        body::before {
            content: ''; position: fixed; top: 0; left: 0;
            width: 200%; height: 200%; z-index: -1;
            background: radial-gradient(circle at 20% 20%, rgba(213, 0, 0, 0.08), transparent 30%),
                        radial-gradient(circle at 80% 70%, rgba(213, 0, 0, 0.08), transparent 30%);
            animation: gradient-flow 30s ease-in-out infinite;
        }
        @keyframes gradient-flow {
            0% { transform: translate(0, 0); } 50% { transform: translate(-50%, -10%); } 100% { transform: translate(0, 0); }
        }

        .container { max-width: var(--container-max-width); margin: 0 auto; padding: 0 var(--spacing-md); }

        /* Header */
        .main-header {
            position: sticky; top: 0; z-index: 1000;
            padding: var(--spacing-sm) 0;
            background-color: rgba(5, 5, 5, 0.85);
            backdrop-filter: blur(12px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--color-light-gray);
        }
        .navbar { display: flex; justify-content: space-between; align-items: center; }
        .logo { text-decoration: none; color: var(--color-red); font-family: var(--font-heading); font-weight: 700; font-size: 2rem; }
        .nav-links { display: flex; gap: var(--spacing-md); list-style: none; }
        .nav-links a {
            color: var(--color-white); text-decoration: none; font-weight: 500; position: relative; padding: 0.5rem 0;
        }
        .nav-links a::after {
            content: ''; position: absolute; width: 0; height: 2px; bottom: 0; left: 0;
            background-color: var(--color-red); transition: width var(--transition-smooth);
        }
        .nav-links a:hover::after, .nav-links a.active::after { width: 100%; }

        /* Main Content Layout */
        .collection-layout {
            display: grid; grid-template-columns: 1fr;
            gap: var(--spacing-lg); padding: var(--spacing-lg) 0;
        }
        @media (min-width: 1024px) {
            .collection-layout { grid-template-columns: 320px 1fr; }
        }

        /* Filter Sidebar */
        .filter-sidebar {
            background: rgba(33, 33, 33, 0.3);
            border: 1px solid var(--color-light-gray);
            border-radius: var(--border-radius); padding: var(--spacing-md);
            backdrop-filter: blur(10px); align-self: start;
        }
        @media (min-width: 1024px) { .filter-sidebar { position: sticky; top: 100px; } }
        .filter-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-bottom: var(--spacing-sm); }
        .filter-title { font-family: var(--font-heading); font-size: 1.8rem; }
        .filter-toggle { background: none; border: none; color: var(--color-white); font-size: 1.5rem; transition: transform 0.4s ease; }
        @media (min-width: 1024px) { .filter-toggle { display: none; } }

        /* Mobile Filter Animation */
        .filter-content { display: flex; flex-direction: column; gap: var(--spacing-md); }
        @media (max-width: 1023px) {
            .filter-content {
                max-height: 0; overflow: hidden; opacity: 0;
                transition: max-height 0.5s ease, opacity 0.5s ease, margin-top 0.5s ease;
            }
            .filter-content.expanded { max-height: 1000px; opacity: 1; margin-top: var(--spacing-md); }
            .filter-toggle.active { transform: rotate(180deg); }
        }

        .filter-group-title { font-weight: 600; margin-bottom: var(--spacing-sm); font-size: 1.1rem; }
        .filter-options { display: flex; flex-wrap: wrap; gap: 10px; }
        .filter-option input { position: absolute; opacity: 0; }
        .filter-option label {
            display: block; padding: 8px 16px; background: var(--color-mid-gray);
            border: 1px solid var(--color-light-gray); border-radius: 50px;
            cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem;
        }
        .filter-option input:checked + label { background: var(--color-red); border-color: var(--color-red); color: white; }

        /* Products Area */
        .products-area { min-width: 0; }
        .products-toolbar { display: flex; flex-wrap: wrap; gap: var(--spacing-sm); margin-bottom: var(--spacing-md); }
        .search-input, .sort-select {
            background: var(--color-dark-gray); border: 1px solid var(--color-light-gray);
            color: var(--color-white); padding: 14px 18px; border-radius: 12px;
            font-family: inherit; font-size: 1rem; flex-grow: 1; outline: none;
        }
        .search-input:focus, .sort-select:focus { border-color: var(--color-red); }

        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--spacing-md); }

        .product-card {
            background-color: var(--color-dark-gray); border-radius: var(--border-radius);
            text-decoration: none; color: var(--color-white);
            border: 1px solid var(--color-light-gray); display: flex; flex-direction: column;
            overflow: hidden; transition: all var(--transition-smooth); will-change: transform;
            position: relative;
        }
        .product-card:hover { transform: translateY(-10px); box-shadow: var(--shadow-card); border-color: var(--color-red); }

        .product-image-container { position: relative; padding-top: 75%; overflow: hidden; background-color: var(--color-mid-gray); }
        .product-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: transform 0.8s ease; }
        .product-card:hover .product-image { transform: scale(1.1); }

        .product-info { padding: var(--spacing-sm) var(--spacing-md); flex-grow: 1; display: flex; flex-direction: column; }
        .product-category { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--color-red); margin-bottom: 0.5rem; }
        .product-info h3 { font-family: var(--font-heading); font-size: 1.5rem; color: var(--color-white); margin-bottom: 0.75rem; line-height: 1.2; }

        /* FIXED PRICE STYLING TO PREVENT OVERFLOW */
        .product-price {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 1.5rem;
        }
        .product-price .current-price {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-white);
        }
        .product-price .original-price {
            font-size: 0.9rem;
            color: #888;
            text-decoration: line-through;
            opacity: 0.8;
        }

        .product-cta-button {
            margin-top: auto; padding: 12px 20px; border-radius: 50px;
            background: var(--color-mid-gray); border: 1px solid var(--color-light-gray);
            color: var(--color-white); text-align: center; font-weight: 600;
            transition: all 0.3s ease;
        }
        .product-card:hover .product-cta-button {
            background: var(--color-red);
            border-color: var(--color-red);
            box-shadow: 0 0 20px rgba(213,0,0,0.4);
        }

        /* Preloader */
        #preloader { position: fixed; inset: 0; background: var(--color-black); z-index: 9999; display: grid; place-items: center; }
        .loader { width: 60px; height: 60px; border: 4px solid var(--color-light-gray); border-top-color: var(--color-red); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* No Results */
        .no-results { text-align: center; padding: 4rem 0; color: var(--color-light-gray); }
        .no-results i { font-size: 3rem; margin-bottom: 1rem; color: var(--color-red); }
    </style>
</head>
<body>
    <div id="preloader"><div class="loader"></div></div>

    <header class="main-header">
        <div class="container">
            <nav class="navbar">
                <!-- FIXED: Changed h3 to h2 to match opening tag and fixed inline style -->
                <a href="{{ url_for('main.index') }}" class="logo">Maryam Kolleksiya</a>
                <div class="nav-links">
                    <a href="{{ url_for('main.index') }}" >Bosh Sahifa</a>
                    <a href="{{ url_for('main.collection') }}" class="active">Kolleksiya</a>
                    <a href="{{ url_for('main.contact') }}">Bog'lanish</a>
                </div>
            </nav>
        </div>
    </header>

    <main>
        <div class="container collection-layout">
            <aside class="filter-sidebar">
                <div class="filter-header" id="filterHeader">
                    <h3 class="filter-title">Filtrlar</h3>
                    <button class="filter-toggle" id="filterToggle"><i class="fas fa-chevron-down"></i></button>
                </div>
                <div class="filter-content" id="filterContent">
                    <div class="filter-group">
                        <h4 class="filter-group-title">Kategoriya</h4>
                        <div class="filter-options" id="categoryFilters">
                            <div class="filter-option"><input type="radio" id="cat-all" name="category" value="all" checked><label for="cat-all">Barchasi</label></div>
                            <div class="filter-option"><input type="radio" id="cat-mehmonxona" name="category" value="mehmonxona"><label for="cat-mehmonxona">Mehmonxona</label></div>
                            <div class="filter-option"><input type="radio" id="cat-yotoq" name="category" value="yotoq"><label for="cat-yotoq">Yotoqxona</label></div>
                            <div class="filter-option"><input type="radio" id="cat-ofis" name="category" value="ofis"><label for="cat-ofis">Ofis</label></div>
                            <div class="filter-option"><input type="radio" id="cat-oshxona" name="category" value="oshxona"><label for="cat-oshxona">Oshxona</label></div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <h4 class="filter-group-title">Narx Oralig'i</h4>
                        <input type="range" id="priceRange" min="0" max="20000000" step="100000" value="20000000" style="width: 100%; accent-color: var(--color-red);">
                        <p style="text-align: right; margin-top: 0.5rem; font-size: 0.9rem;">gacha <span id="priceValue" style="color: var(--color-red); font-weight:600;">20,000,000</span> so'm</p>
                    </div>
                </div>
            </aside>

            <section class="products-area">
                <div class="products-toolbar">
                    <input type="text" id="searchInput" class="search-input" placeholder="Mahsulot qidirish...">
                    <select class="sort-select" id="sortSelect">
                        <option value="default">Saralash: Tavsiya etilgan</option>
                        <option value="price-low">Narx: Arzondan</option>
                        <option value="price-high">Narx: Qimmatdan</option>
                        <option value="name-asc">Nomi: A-Z</option>
                        <option value="name-desc">Nomi: Z-A</option>
                    </select>
                </div>
                <!-- The product grid is now initially empty. JS will fill it. -->
                <div class="product-grid" id="productGrid"></div>
            </section>
        </div>
    </main>



    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA INITIALIZATION ---
        const allProducts = [
            {% if products %}
                {% for product in products %}
                {
                    slug: {{ product.slug | tojson }},
                    name: {{ product.name | tojson }},
                    category: {{ (product.category or 'umumiy') | tojson | lower }},
                    price: {{ product.price or 0 }},
                    discount: {{ product.discount or 0 }},
                    main_image: {{ product.main_image | tojson }},
                    url: "{{ url_for('main.product', product_name=product.slug) }}"
                },
                {% endfor %}
            {% endif %}
        ];

        // --- ELEMENTS ---
        const elements = {
            productGrid: document.getElementById('productGrid'),
            searchInput: document.getElementById('searchInput'),
            sortSelect: document.getElementById('sortSelect'),
            categoryFilters: document.getElementById('categoryFilters'),
            priceRange: document.getElementById('priceRange'),
            priceValue: document.getElementById('priceValue'),
            filterHeader: document.getElementById('filterHeader'),
            filterContent: document.getElementById('filterContent'),
            filterToggle: document.getElementById('filterToggle'),
            preloader: document.getElementById('preloader')
        };

        // --- DATA TRANSFORMATION ---
        allProducts.forEach(p => {
            p.discountPrice = (p.discount > 0) ? (p.price * (1 - p.discount / 100)) : null;
        });

        // --- RENDER PRODUCTS ---
        const renderProducts = (products) => {
            elements.productGrid.innerHTML = '';

            if (products.length === 0) {
                elements.productGrid.innerHTML = `
                    <div class="no-results" style="grid-column: 1 / -1;">
                        <i class="fas fa-search"></i>
                        <h3>Mahsulot Topilmadi</h3>
                        <p>Qidiruv so'zini yoki filtrlarni o'zgartirib ko'ring.</p>
                    </div>`;
                return;
            }

            products.forEach(p => {
                const card = document.createElement('a');
                card.href = p.url;
                card.className = 'product-card';

                // Format prices safely
                const currentPrice = (p.discountPrice || p.price).toLocaleString('uz-UZ');
                const oldPrice = p.price.toLocaleString('uz-UZ');

                // Price HTML logic - fixed structure for proper wrapping
                let priceHtml = '';
                if (p.discountPrice) {
                    priceHtml = `
                        <span class="current-price">${currentPrice} so'm</span>
                        <span class="original-price">${oldPrice} so'm</span>
                    `;
                } else {
                    priceHtml = `<span class="current-price">${currentPrice} so'm</span>`;
                }

                card.innerHTML = `
                    <div class="product-image-container">
                        <img src="${p.main_image || 'https://images.unsplash.com/photo-1555041469-a586c61ea9bc?auto=format&fit=crop&w=800&q=80'}"
                             alt="${p.name}"
                             class="product-image"
                             loading="lazy"
                             onerror="this.src='https://placehold.co/600x400/212121/F5F5F5?text=No+Image'">
                    </div>
                    <div class="product-info">
                        <p class="product-category">${p.category}</p>
                        <h3>${p.name}</h3>
                        <div class="product-price">${priceHtml}</div>
                        <div class="product-cta-button">Batafsil</div>
                    </div>`;
                elements.productGrid.appendChild(card);
            });

            // Grid Animation on Render
            gsap.from(".product-card", {
                opacity: 0,
                y: 30,
                duration: 0.6,
                stagger: 0.05,
                ease: 'power2.out',
                clearProps: "all"
            });
        };

        // --- FILTER & SORT LOGIC ---
        const updateProducts = () => {
            let filtered = [...allProducts];
            const searchTerm = elements.searchInput.value.toLowerCase().trim();
            const category = document.querySelector('input[name="category"]:checked').value;
            const maxPrice = parseInt(elements.priceRange.value);
            const sortBy = elements.sortSelect.value;

            if (searchTerm) filtered = filtered.filter(p => p.name.toLowerCase().includes(searchTerm));
            if (category !== 'all') filtered = filtered.filter(p => p.category === category);

            // Filter by current active price
            filtered = filtered.filter(p => (p.discountPrice || p.price) <= maxPrice);

            switch(sortBy) {
                case 'price-low': filtered.sort((a, b) => (a.discountPrice || a.price) - (b.discountPrice || b.price)); break;
                case 'price-high': filtered.sort((a, b) => (b.discountPrice || b.price) - (a.discountPrice || a.price)); break;
                case 'name-asc': filtered.sort((a, b) => a.name.localeCompare(b.name)); break;
                case 'name-desc': filtered.sort((a, b) => b.name.localeCompare(a.name)); break;
            }
            renderProducts(filtered);
        };

        // --- EVENT LISTENERS ---
        ['input', 'change'].forEach(evt => {
            elements.searchInput.addEventListener(evt, updateProducts);
            elements.sortSelect.addEventListener(evt, updateProducts);
            elements.categoryFilters.addEventListener(evt, updateProducts);
            elements.priceRange.addEventListener(evt, () => {
                elements.priceValue.textContent = parseInt(elements.priceRange.value).toLocaleString('uz-UZ');
                updateProducts();
            });
        });

        // --- UI INTERACTIONS ---

        // Remove Preloader
        window.onload = () => {
             gsap.to(elements.preloader, { opacity: 0, duration: 0.8, onComplete: () => elements.preloader.style.display = 'none' });
        };
        // Fallback in case window load fails or is too slow
        setTimeout(() => {
            if(elements.preloader.style.display !== 'none') {
                gsap.to(elements.preloader, { opacity: 0, duration: 0.8, onComplete: () => elements.preloader.style.display = 'none' });
            }
        }, 3000);

        // Mobile Filter Toggle
        elements.filterHeader.addEventListener('click', () => {
            elements.filterContent.classList.toggle('expanded');
            elements.filterToggle.classList.toggle('active');
        });

        // 3D Tilt Effect - OPTIMIZED
        elements.productGrid.addEventListener('mousemove', e => {
            const card = e.target.closest('.product-card');
            if (!card) return;

            const rect = card.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Calculate rotation based on center
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;

            // Limit rotation to 5 degrees
            const rotateX = ((y - centerY) / centerY) * -5;
            const rotateY = ((x - centerX) / centerX) * 5;

            gsap.to(card, {
                rotationX: rotateX,
                rotationY: rotateY,
                transformPerspective: 1000,
                scale: 1.02,
                ease: 'power1.out',
                duration: 0.4
            });
        });

        // Reset Card on Mouse Leave
        elements.productGrid.addEventListener('mouseout', e => {
            const card = e.target.closest('.product-card');
            if (card && !e.relatedTarget?.closest('.product-card')) {
                gsap.to(card, {
                    rotationX: 0,
                    rotationY: 0,
                    scale: 1,
                    ease: 'power1.out',
                    duration: 0.6
                });
            }
        });

        // --- INITIAL RENDER ---
        updateProducts();
    });
    </script>
</body>
</html>